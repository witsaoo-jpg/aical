<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Calorie Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary-color: #34C759;
            --text-dark: #1C1C1E;
            --text-light: #8E8E93;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Kanit', sans-serif;
            background-color: #000;
            height: 100vh; overflow: hidden;
            display: flex; justify-content: center;
        }

        .app-container {
            width: 100%; max-width: 500px; height: 100%;
            position: relative; background: #000;
            display: flex; flex-direction: column;
        }

        /* ‡∏Å‡∏•‡πâ‡∏≠‡∏á */
        .camera-view {
            flex: 1; position: relative; overflow: hidden;
            border-radius: 0 0 24px 24px;
        }
        video { width: 100%; height: 100%; object-fit: cover; display: block; }

        .header-overlay {
            position: absolute; top: 50px; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px;
            box-sizing: border-box; z-index: 10;
        }
        .header-badge {
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            padding: 5px 15px; border-radius: 20px;
            color: #fff; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.2);
        }
        .settings-btn {
            background: rgba(0,0,0,0.5); border: none;
            color: white; padding: 5px 10px; border-radius: 50%;
            cursor: pointer; font-size: 1.2rem;
        }

        .focus-frame {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 70%; height: 40%;
            border: 2px dashed rgba(255, 255, 255, 0.6);
            border-radius: 20px; pointer-events: none;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î */
        .controls-area {
            height: 140px; background: #000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .shutter-btn {
            width: 72px; height: 72px; border-radius: 50%;
            border: 4px solid #fff; position: relative;
            cursor: pointer; transition: transform 0.2s;
        }
        .shutter-btn::after {
            content: ''; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; background: #fff; border-radius: 50%;
        }
        .shutter-btn:active { transform: scale(0.9); opacity: 0.8; }
        
        .credit-text {
            font-size: 0.75rem; color: rgba(255, 255, 255, 0.3);
            text-align: center; margin-top: 15px; font-weight: 300;
        }

        /* ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå */
        .result-modal {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #fff; border-radius: 24px 24px 0 0;
            padding: 24px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.4s ease;
            z-index: 50;
        }
        .result-modal.active { transform: translateY(0); }
        .nutrition-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;
        }
        .nutri-card {
            background: #F9F9F9; padding: 15px; border-radius: 16px; text-align: center;
        }
        .nutri-value { font-size: 1.4rem; font-weight: 600; color: var(--text-dark); display: block; }
        .nutri-label { font-size: 0.8rem; color: var(--text-light); }
        .close-btn { 
            background: #eee; border: none; padding: 10px; width: 100%; 
            border-radius: 12px; font-family: 'Kanit'; font-size: 1rem; cursor: pointer; 
        }

        /* Modal ‡πÉ‡∏™‡πà Key */
        .key-modal {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .key-box {
            background: white; padding: 25px; border-radius: 20px; width: 80%; max-width: 300px;
            text-align: center;
        }
        .key-input {
            width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ddd;
            border-radius: 8px; box-sizing: border-box;
        }
        .save-btn {
            background: var(--primary-color); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; width: 100%; cursor: pointer;
        }
        
        /* Loading */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 40;
            display: none; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3);
            border-top-color: var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="camera-view">
            <video id="video" autoplay playsinline muted></video>
            <div class="header-overlay">
                <span class="header-badge">ü•ó AI Scan</span>
                <button class="settings-btn" onclick="showKeyModal()">‚öôÔ∏è</button>
            </div>
            <div class="focus-frame"></div>
        </div>
        <canvas id="canvas"></canvas>

        <div class="controls-area">
            <div class="shutter-btn" onclick="takePhoto()"></div>
            <div class="credit-text">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï : ‡∏û‡∏ß.‡∏ß‡∏¥‡∏©‡∏ì‡∏∏‡∏Å‡∏£‡∏ì‡πå ‡πÇ‡∏≠‡∏¢‡∏≤</div>
        </div>

        <div class="loading-overlay" id="loading">
            <div class="spinner"></div>
            <p>AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏´‡∏≤‡∏£...</p>
        </div>

        <div class="key-modal" id="keyModal">
            <div class="key-box">
                <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key</h3>
                <p style="font-size:0.8rem; color:#666;">‡πÉ‡∏™‡πà Google Gemini API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                <input type="password" id="apiKeyInput" class="key-input" placeholder="‡∏ß‡∏≤‡∏á Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...">
                <button class="save-btn" onclick="saveKey()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <div style="margin-top:10px;">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-size:0.7rem; color:#999;">‡∏Ç‡∏≠‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ü‡∏£‡∏µ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
                </div>
            </div>
        </div>

        <div class="result-modal" id="resultModal">
            <h2 id="resName" style="margin:0 0 5px 0;">...</h2>
            <span style="font-size: 0.9rem; color: #888;">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
            
            <div class="nutrition-grid">
                <div class="nutri-card" style="background:#E8F5E9;">
                    <span class="nutri-value" id="resCal" style="color:var(--primary-color);">--</span>
                    <span class="nutri-label">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</span>
                </div>
                <div class="nutri-card">
                    <span class="nutri-value" id="resProt">--</span>
                    <span class="nutri-label">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (g)</span>
                </div>
                <div class="nutri-card">
                    <span class="nutri-value" id="resCarb">--</span>
                    <span class="nutri-label">‡∏Ñ‡∏≤‡∏£‡πå‡∏ö (g)</span>
                </div>
                <div class="nutri-card">
                    <span class="nutri-value" id="resFat">--</span>
                    <span class="nutri-label">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô (g)</span>
                </div>
            </div>
            <button class="close-btn" onclick="closeModal()">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const loading = document.getElementById('loading');
        const resultModal = document.getElementById('resultModal');
        const keyModal = document.getElementById('keyModal');

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Key ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        window.onload = () => {
            initCamera();
            if(!localStorage.getItem('gemini_api_key')){
                showKeyModal();
            }
        };

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
            } catch (err) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á");
            }
        }

        function showKeyModal() {
            keyModal.style.display = 'flex';
            document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key') || '';
        }

        function saveKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) {
                localStorage.setItem('gemini_api_key', key);
                keyModal.style.display = 'none';
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Key ‡πÅ‡∏•‡πâ‡∏ß! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
            } else {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Key ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            }
        }

        async function takePhoto() {
            const API_KEY = localStorage.getItem('gemini_api_key');
            if (!API_KEY) { showKeyModal(); return; }

            loading.style.display = 'flex';
            
            // Capture
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const imageBase64 = canvas.toDataURL('image/jpeg').split(',')[1];

            // Send to AI
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`, {

                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "Identify this food in Thai name. Estimate calories(kcal), protein(g), carbs(g), and fat(g). Return ONLY a JSON object like this: { \"name\": \"...\", \"cal\": 0, \"prot\": 0, \"carb\": 0, \"fat\": 0 }" },
                                { inline_data: { mime_type: "image/jpeg", data: imageBase64 } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                // Parse Result
                if(data.error) throw new Error(data.error.message);
                const aiText = data.candidates[0].content.parts[0].text;
                const cleanJson = aiText.replace(/```json|```/g, '').trim();
                const result = JSON.parse(cleanJson);

                // Show Result
                document.getElementById('resName').innerText = result.name;
                document.getElementById('resCal').innerText = result.cal;
                document.getElementById('resProt').innerText = result.prot;
                document.getElementById('resCarb').innerText = result.carb;
                document.getElementById('resFat').innerText = result.fat;

                loading.style.display = 'none';
                resultModal.classList.add('active');

            } catch (error) {
                loading.style.display = 'none';
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
                // ‡∏ñ‡πâ‡∏≤ Error ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Key ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                if(error.message.includes('API_KEY')) showKeyModal();
            }
        }

        function closeModal() {
            resultModal.classList.remove('active');
        }
        
        // Register PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
